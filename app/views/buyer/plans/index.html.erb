<% if @bill %>
  <h1> Latest Available Bill for <%= current_user.email %></h1>
  <%= "Total: $#{@bill.total}" %><br />
  <%= "Generated at: #{@bill.created_at}" %>
<% end %>

<% if @subscriptions.present? %>
  <h1> Currently Subscribed Plans: </h1>
  <div class='list-group'>
    <% @subscriptions.each do |subscription| %>
      <div class='list-group-item'>
        <% plan = subscription.plan %>
        <strong class='text-primary'>Subscription Name: </strong> <%= subscription.name %><br />
        <%= link_to 'Unsubscribe', buyer_subscription_path(subscription), method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-danger float-right' %>
        <strong>Monthly Fee: </strong><%= plan.monthly_fee %>
        <% plan.features.each do |feature| %>
          <div class='list-group-item mt-4'>
            <%= "Feature Name: #{feature.name}" %><br />
            <%= "Unit Price: #{feature.unit_price}" %>
            <%= link_to 'Consume Unit', increment_consumed_buyer_subscription_feature_path(feature.id, subscription_feature: { subscription_id: subscription.id, feature_id: feature.id }), method: :patch, class: "list-group-item btn btn-primary float-right mx-3" %>
            <% subscription_feature = get_subscription_feature(subscription.id, feature.id) %>
            <div class="d-flex p-2 bd-highlight">
              <p class="text-primary">Allocated Units: </p><%= get_allocated_units(plan, feature.id) %>
              <% if subscription_feature %>
                <p class="text-primary ms-3">Consumed Units: </p><%= subscription_feature.consumed_units %>
              <% else %>
                <p class="text-primary ms-3">Consumed Units: </p>0
              <% end %>
            </div>
          </div>
          <br />
        <% end %>
      </div>
    <% end %>
<% end %>

<h1> Available Plans to Choose From : </h1>
<div class="row">
  <% @plans.each do |plan| %>
    <div class="col-sm-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title"><%= plan.name %> for $<%= plan.monthly_fee %></h5>
          <ul class="card-text">
            <% plan.features.each do |feature| %>
              <li><%= feature.name %></li>
            <% end %>
          </ul>
          <div><%= link_to 'Explore', buyer_plan_path(plan), class: 'btn btn-primary' %></div>
        </div>
      </div>
    </div>
  <% end %>
</div>
